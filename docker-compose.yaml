version: "3.9"

networks:
  kong-net:
    driver: bridge

services:
  kong-gateway:
    image: kong/kong-gateway:3.12
    container_name: kong-gateway
    environment:
      KONG_ROLE: data_plane
      KONG_DATABASE: "off"
      KONG_VITALS: "off"
      KONG_CLUSTER_MTLS: pki
      KONG_CLUSTER_CONTROL_PLANE: changeme.au.cp0.konghq.com:443
      KONG_CLUSTER_SERVER_NAME: changeme.au.cp0.konghq.com
      KONG_CLUSTER_TELEMETRY_ENDPOINT: changeme.au.tp0.konghq.com:443
      KONG_CLUSTER_TELEMETRY_SERVER_NAME: changeme.au.tp0.konghq.com
      KONG_CLUSTER_CERT: |
        -----BEGIN CERTIFICATE-----
        changeme
        -----END CERTIFICATE-----
      KONG_CLUSTER_CERT_KEY: |
        -----BEGIN PRIVATE KEY-----
        changeme
        -----END PRIVATE KEY-----
      KONG_LUA_SSL_TRUSTED_CERTIFICATE: system
      KONG_KONNECT_MODE: "on"
      KONG_UNTRUSTED_LUA: "on"
      KONG_CLUSTER_DP_LABELS: type:docker-macOsArmOS
      KONG_ROUTER_FLAVOR: expressions
      KONG_STATUS_LISTEN: 0.0.0.0:8100
    networks:
      - kong-net
    ports:
      - "8000:8000"
      - "8443:8443"
      - "8100:8100"

  keycloak-mcp:
    container_name: keycloak-mcp
    image: quay.io/keycloak/keycloak:22.0
    command:
      - >
        start-dev
        --http-port=8081
        --https-port=8441
        --hostname=localhost
        --hostname-strict=false
        --https-certificate-file=/opt/keycloak/certs/localhost.pem
        --https-certificate-key-file=/opt/keycloak/certs/localhost-key.pem
        --import-realm
    volumes:
      - ./mcp/demo.json:/opt/keycloak/data/import/demo.json
      - ./certs:/opt/keycloak/certs:ro # Mount the directory containing the certs
    environment:
      KEYCLOAK_ADMIN: changeme
      KEYCLOAK_ADMIN_PASSWORD: changeme
      DB_VENDOR: h2
      JAVA_OPTS_APPEND: -Dkeycloak.migration.strategy=OVERWRITE_EXISTING
    ports:
      - "8081:8081"
      - "8441:8441"
    networks:
      - kong-net
