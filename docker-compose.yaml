version: "3.9"

networks:
  kong-net:
    driver: bridge

services:
  kong-gateway:
    image: kong/kong-gateway:3.12
    container_name: kong-gateway
    environment:
      KONG_ROLE: data_plane
      KONG_DATABASE: "off"
      KONG_VITALS: "off"
      KONG_CLUSTER_MTLS: pki
      KONG_CLUSTER_CONTROL_PLANE: 02d9847534.au.cp0.konghq.com:443
      KONG_CLUSTER_SERVER_NAME: 02d9847534.au.cp0.konghq.com
      KONG_CLUSTER_TELEMETRY_ENDPOINT: 02d9847534.au.tp0.konghq.com:443
      KONG_CLUSTER_TELEMETRY_SERVER_NAME: 02d9847534.au.tp0.konghq.com
      KONG_CLUSTER_CERT: |
        -----BEGIN CERTIFICATE-----
        MIICFzCCAbygAwIBAgIBATAKBggqhkjOPQQDBDA8MTowCQYDVQQGEwJBVTAtBgNV
        BAMeJgBrAG8AbgBuAGUAYwB0AC0AawBvAG4AbgBlAGMAdAAtAGwAYQBiMB4XDTI1
        MTAzMTA5MTU1M1oXDTM1MTAzMTA5MTU1M1owPDE6MAkGA1UEBhMCQVUwLQYDVQQD
        HiYAawBvAG4AbgBlAGMAdAAtAGsAbwBuAG4AZQBjAHQALQBsAGEAYjBZMBMGByqG
        SM49AgEGCCqGSM49AwEHA0IABFb+vxkKNzKOPBYRKRiinKj9ysZ9p+hEbBs8bhKs
        vKYOeJeS0l3t7JNKS/oFBic2CvB8DZvmR4cSed7l0tQHisujga4wgaswDAYDVR0T
        AQH/BAIwADALBgNVHQ8EBAMCAAYwHQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsGAQUF
        BwMCMBcGCSsGAQQBgjcUAgQKDAhjZXJ0VHlwZTAjBgkrBgEEAYI3FQIEFgQUAQEB
        AQEBAQEBAQEBAQEBAQEBAQEwHAYJKwYBBAGCNxUHBA8wDQYFKQEBAQECAQoCARQw
        EwYJKwYBBAGCNxUBBAYCBAAUAAowCgYIKoZIzj0EAwQDSQAwRgIhANBLG3IRFgm8
        2vzJktVQumqy7oOBBheR6187j8SLX7GMAiEA1k37+kFQmKbe3OI3L+Jj4+YIgFde
        0Ornad1h2bOZ/Pc=
        -----END CERTIFICATE-----
      KONG_CLUSTER_CERT_KEY: |
        -----BEGIN PRIVATE KEY-----
        MIGTAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBHkwdwIBAQQgo8wfJqui3PQHhfHJ
        8JqFB53PnQMmntFuW8+NIRVbPpWgCgYIKoZIzj0DAQehRANCAARW/r8ZCjcyjjwW
        ESkYopyo/crGfafoRGwbPG4SrLymDniXktJd7eyTSkv6BQYnNgrwfA2b5keHEnne
        5dLUB4rL
        -----END PRIVATE KEY-----
      KONG_LUA_SSL_TRUSTED_CERTIFICATE: system
      KONG_KONNECT_MODE: "on"
      KONG_UNTRUSTED_LUA: "on"
      KONG_CLUSTER_DP_LABELS: type:docker-macOsArmOS
      KONG_ROUTER_FLAVOR: expressions
      KONG_STATUS_LISTEN: 0.0.0.0:8100
    networks:
      - kong-net
    ports:
      - "8000:8000"
      - "8443:8443"
      - "8100:8100"

  keycloak-mcp:
    container_name: keycloak-mcp
    image: quay.io/keycloak/keycloak:22.0
    command:
      - >
        start-dev
        --http-port=8081
        --https-port=8441
        --hostname=localhost
        --hostname-strict=false
        --https-certificate-file=/opt/keycloak/certs/localhost.pem
        --https-certificate-key-file=/opt/keycloak/certs/localhost-key.pem
        --import-realm
    volumes:
      - ./mcp/demo.json:/opt/keycloak/data/import/demo.json
      - ./certs:/opt/keycloak/certs:ro # Mount the directory containing the certs
    environment:
      KEYCLOAK_ADMIN: changeme
      KEYCLOAK_ADMIN_PASSWORD: changeme
      DB_VENDOR: h2
      JAVA_OPTS_APPEND: -Dkeycloak.migration.strategy=OVERWRITE_EXISTING
    ports:
      - "8081:8081"
      - "8441:8441"
    networks:
      - kong-net
